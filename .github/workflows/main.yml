name: DevSecOps Pipeline


on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main


jobs:
  gitleaks:
      name: Gitleaks
      runs-on: ubuntu-latest
      steps:
        - name: Gitleaks Scan
          shell: bash
          run: |
                sudo apt-get update -y
                sudo apt-get upgrade -y
                sudo apt-get install git wget golang-go -y
                sudo wget https://github.com/gitleaks/gitleaks/releases/download/v8.17.0/gitleaks_8.17.0_linux_x64.tar.gz
                sudo tar -zxvf gitleaks_8.17.0_linux_x64.tar.gz
                sudo chmod +x gitleaks
                sudo mv gitleaks /usr/local/bin/
                sudo set +e
                sudo gitleaks detect -v -r gitleaks-report.json
                sudo set -e

  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    needs: [gitleaks]
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  dependency_check:
    name: Dependency check Scan
    runs-on: ubuntu-latest
    needs: [sonarcloud]
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Depcheck
        uses: dependency-check/Dependency-Check_Action@main
        id: Depcheck
        with:
          project: "test"
          path: "."
          format: "HTML"
      - name: Upload Test results
        uses: actions/upload-artifact@master
        with:
          name: Depcheck report
          path: ${{github.workspace}}/reports
